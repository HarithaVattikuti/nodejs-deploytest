name: Test cache restore 

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # Checkout repository
      - uses: actions/checkout@v6
      # Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '21'
      - name: Normalize runner architecture (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: echo "ARCH=$(echo '${{ runner.arch }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
      - name: Normalize runner architecture (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
           $arch = "${{ runner.arch }}".ToLower()
           echo "ARCH=$arch" | Out-File $env:GITHUB_ENV -Append
      # Detect package manager and its cache path
      - name: Detect package manager and cache path
        shell: bash
        run: |
          set -e
          # UPDATE THESE VALUES FOR YOUR PROJECT:
          PACKAGE_MANAGER="npm"              # Specify: npm, yarn, or pnpm
          CACHE_PATH="$(npm config get cache)"      # npm: npm config get cache | yarn: yarn cache dir | pnpm: pnpm store path
          LOCK_PATTERN="**/package-lock.json"                # npm: **/package-lock.json | yarn: **/yarn.lock | pnpm: **/pnpm-lock.yaml
          echo "PACKAGE_MANAGER=$PACKAGE_MANAGER" >> $GITHUB_ENV
          echo "NODE_CACHE=$CACHE_PATH" >> $GITHUB_ENV
          echo "LOCK_PATTERN=$LOCK_PATTERN" >> $GITHUB_ENV
      # Restore dependency cache using a unified key format
      - name: Restore Node cache
        uses: actions/cache/restore@v5
        with:
          path: ${{ env.NODE_CACHE }}
          key: node-cache-${{ runner.os }}-${{ env.ARCH }}-${{ env.PACKAGE_MANAGER }}-${{ hashFiles(env.LOCK_PATTERN) }}
      # Install dependencies based on detected package manager
      - name: Install dependencies
        shell: bash
        run: npm ci    # npm: npm ci | yarn: yarn install --frozen-lockfile | pnpm: pnpm install --frozen-lockfile
